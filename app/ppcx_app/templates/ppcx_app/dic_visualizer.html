<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DIC Visualizer</title>
  <style>
    body { font-family: sans-serif; margin: 18px; }
    .container { display:flex; gap:18px; }
    .left { width: 360px; }
    .right { flex:1; }
    .dic-row { padding:8px; border-bottom:1px solid #eee; cursor:pointer; }
    .dic-row:hover { background:#fafafa; }
    label { display:block; margin-top:8px; font-size:0.9rem; }
    input, select { width:100%; padding:6px; box-sizing:border-box; }
    .controls { margin-top:12px; }
    .preview { border:1px solid #ddd; padding:6px; background:#fff; }
    .small { font-size:0.85rem; color:#666; }
  </style>
</head>
<body>
  <h2>DIC Visualizer</h2>
  <div class="container">
    <div class="left">
      <form id="filterForm" method="get">
        <label>Reference date (ISO)</label>
        <input name="reference_date" value="{{ request.GET.reference_date|default:'' }}">
        <label>Master timestamp start (ISO)</label>
        <input name="master_timestamp_start" value="{{ request.GET.master_timestamp_start|default:'' }}">
        <label>Master timestamp end (ISO)</label>
        <input name="master_timestamp_end" value="{{ request.GET.master_timestamp_end|default:'' }}">
        <label>Camera name (contains)</label>
        <input name="camera_name" value="{{ request.GET.camera_name|default:'' }}">
        <label>Camera id</label>
        <input name="camera_id" value="{{ request.GET.camera_id|default:'' }}">
        <label>Time diff min (hours)</label>
        <input name="time_difference_min" value="{{ request.GET.time_difference_min|default:'' }}">
        <label>Time diff max (hours)</label>
        <input name="time_difference_max" value="{{ request.GET.time_difference_max|default:'' }}">
        <label>Month (1-12)</label>
        <input name="month" value="{{ request.GET.month|default:'' }}">
        <div style="margin-top:8px;">
          <button type="submit">Filter</button>
          <button type="button" onclick="document.getElementById('filterForm').reset()">Reset</button>
        </div>
      </form>

      <h3 style="margin-top:12px">Matching DICs ({{ dic_list|length }})</h3>
      <div id="dicList">
        {% for d in dic_list %}
          <div class="dic-row" data-dic-id="{{ d.id }}" onclick="selectDic(this)">
            <div><strong>#{{ d.id }}</strong> — <span class="small">{{ d.master_timestamp }} → {{ d.slave_timestamp }}</span></div>
            <div class="small">
              {% if d.master_image and d.master_image.camera %}
                {{ d.master_image.camera.camera_name }}
              {% else %}
                <!-- no camera -->
              {% endif %}
            </div>
          </div>
        {% empty %}
      </div>
    </div>

    <div class="right">
      <div class="controls">
        <label>Selected DIC id</label>
        <input id="selectedDic" readonly value="{{ selected_dic_id|default:'' }}">
        <label>Plot type</label>
        <select id="plot_type"><option value="quiver">quiver</option><option value="scatter">scatter</option></select>
        <label>Colormap</label>
        <input id="cmap" value="{{ plot_opts.cmap }}">
        <label>Subsample (every n-th)</label>
        <input id="subsample" value="{{ plot_opts.subsample }}">
        <label>Min velocity (leave empty for none)</label>
        <input id="min_velocity" value="{{ plot_opts.min_velocity }}">
        <label class="small">Other options (vmin,vmax,scale,figsize,dpi...)</label>
        <div style="display:flex;gap:8px">
          <input id="vmin" placeholder="vmin" style="width:30%" value="{{ plot_opts.vmin }}">
          <input id="vmax" placeholder="vmax" style="width:30%" value="{{ plot_opts.vmax }}">
          <input id="scale" placeholder="scale" style="width:30%" value="{{ plot_opts.scale }}">
        </div>
        <div style="margin-top:8px">
          <button type="button" onclick="updatePreview()">Update preview</button>
        </div>
      </div>

      <h3 style="margin-top:12px">Preview</h3>
      <div class="preview">
        <img id="previewImg" src="" alt="Select a DIC on the left" style="max-width:100%; height:auto;">
      </div>

      <div style="margin-top:12px">
        <a id="downloadLink" href="#" download>Download current PNG</a>
      </div>
    </div>
  </div>

<script>
const baseVisualize = "{{ visualize_base_url }}"; // e.g. /visualize_dic/<dic_id>/
function selectDic(el){
  const dicId = el.getAttribute('data-dic-id');
  document.getElementById('selectedDic').value = dicId;
  updatePreview();
}
function buildUrl(){
  const dicId = document.getElementById('selectedDic').value;
  if(!dicId) return '';
  const params = new URLSearchParams();
  params.set('plot_type', document.getElementById('plot_type').value);
  params.set('cmap', document.getElementById('cmap').value);
  const subs = document.getElementById('subsample').value; if(subs) params.set('subsample', subs);
  const mv = document.getElementById('min_velocity').value; if(mv) params.set('min_velocity', mv);
  const vmin = document.getElementById('vmin').value; if(vmin) params.set('vmin', vmin);
  const vmax = document.getElementById('vmax').value; if(vmax) params.set('vmax', vmax);
  const scale = document.getElementById('scale').value; if(scale) params.set('scale', scale);
  return baseVisualize + dicId + '/?' + params.toString();
}
function updatePreview(){
  const url = buildUrl();
  if(!url) return;
  const img = document.getElementById('previewImg');
  img.src = url + '&_ts=' + Date.now(); // cache bust
  const dl = document.getElementById('downloadLink');
  dl.href = url;
  dl.textContent = 'Download PNG (DIC #' + document.getElementById('selectedDic').value + ')';
}
</script>
</body>
</html>